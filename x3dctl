#!/usr/bin/env bash
set -euo pipefail

SCRIPT_NAME="x3dctl"
HELPER="/usr/local/bin/x3dctl-helper"
CONFIG_FILE="/etc/x3dctl.conf"

QUIET=0
VERBOSE=0

log() {
  if [[ "$QUIET" -eq 0 ]]; then
    echo "[$SCRIPT_NAME] $*" >&2
  fi
}

vlog() {
  if [[ "$QUIET" -eq 0 && "$VERBOSE" -eq 1 ]]; then
    echo "[$SCRIPT_NAME] $*" >&2
  fi
}

die() {
  echo "[$SCRIPT_NAME] ERROR: $*" >&2
  exit 1
}

get_config_mode() {
  local app="$1"
  [[ -f "$CONFIG_FILE" ]] || return 0
  # Exact key match; take first match only
  grep -E "^${app}=" "$CONFIG_FILE" 2>/dev/null | head -n1 | cut -d'=' -f2
}

validate_mode() {
  case "$1" in
    cache|frequency) ;;
    *) die "Invalid mode: $1" ;;
  esac
}

set_global_mode() {
  vlog "Setting global mode to: $1"
  sudo "$HELPER" "$1"
}

get_current_mode() {
  sudo "$HELPER" status | tr -d '\n'
}

pin_self() {
  vlog "Pinning PID $$ to: $1"
  sudo "$HELPER" pin "$$" "$1"
}

toggle_mode() {
  case "$(get_current_mode)" in
    cache) echo "frequency" ;;
    frequency) echo "cache" ;;
    *) die "Unknown current mode" ;;
  esac
}

### Parse Flags
while [[ "${1:-}" == -* ]]; do
  case "$1" in
    -q|--quiet)
      QUIET=1
      shift
      ;;
    -v|--verbose)
      VERBOSE=1
      shift
      ;;
    *)
      die "Unknown flag: $1"
      ;;
  esac
done


# Require at least one command after flags
if [[ $# -eq 0 ]]; then
  die "Usage:
  $SCRIPT_NAME [-v|--verbose] [-q|--quiet] run <command...>
  $SCRIPT_NAME [-v|--verbose] [-q|--quiet] gaming [command...]
  $SCRIPT_NAME [-v|--verbose] [-q|--quiet] performance [command...]
  $SCRIPT_NAME [-v|--verbose] [-q|--quiet] toggle [command...]
  $SCRIPT_NAME [-v|--verbose] [-q|--quiet] status"
fi

COMMAND="$1"
shift


# Ensure helper exists and is executable
[[ -x "$HELPER" ]] || die "Helper not found at $HELPER"

case "$COMMAND" in

  run)
    [[ $# -eq 0 ]] && die "Usage: run <command...>"

    APP_BIN=$(basename "$1")
    TARGET_MODE=$(get_config_mode "$APP_BIN")

    if [[ -z "$TARGET_MODE" ]]; then
      TARGET_MODE="cache"
      vlog "No config entry for $APP_BIN; defaulting to cache"
    else
      vlog "Config entry for $APP_BIN: $TARGET_MODE"
    fi

    validate_mode "$TARGET_MODE"

    set_global_mode "$TARGET_MODE"
    pin_self "$TARGET_MODE"

    exec "$@"
    ;;

  gaming)
    set_global_mode cache

    if [[ $# -gt 0 ]]; then
      pin_self cache
      exec "$@"
    else
      log "Switched to cache"
    fi
    ;;

  performance)
    set_global_mode frequency

    if [[ $# -gt 0 ]]; then
      pin_self frequency
      exec "$@"
    else
      log "Switched to frequency"
    fi
    ;;

  toggle)
    NEW_MODE=$(toggle_mode)
    set_global_mode "$NEW_MODE"

    if [[ $# -gt 0 ]]; then
      pin_self "$NEW_MODE"
      exec "$@"
    else
      log "Switched to $NEW_MODE"
    fi
    ;;

  status)
    get_current_mode
    ;;

  *)
    die "Usage:
  $SCRIPT_NAME [-v|--verbose] [-q|--quiet] run <command...>
  $SCRIPT_NAME [-v|--verbose] [-q|--quiet] gaming [command...]
  $SCRIPT_NAME [-v|--verbose] [-q|--quiet] performance [command...]
  $SCRIPT_NAME [-v|--verbose] [-q|--quiet] toggle [command...]
  $SCRIPT_NAME [-v|--verbose] [-q|--quiet] status"
    ;;
esac

