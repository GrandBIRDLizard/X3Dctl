#!/usr/bin/env bash
set -euo pipefail

SCRIPT_NAME="x3dctl"
HELPER="/usr/local/bin/x3dctl-helper"

QUIET=0
VERBOSE=0
NO_IRQ=0

log() {
  if [[ "$QUIET" -eq 0 ]]; then
    echo "[$SCRIPT_NAME] $*" >&2
  fi
}

vlog() {
  if [[ "$QUIET" -eq 0 && "$VERBOSE" -eq 1 ]]; then
    echo "[$SCRIPT_NAME] $*" >&2
  fi
}

die() {
  echo "[$SCRIPT_NAME] ERROR: $*" >&2
  exit 1
}

[[ -x "$HELPER" ]] || die "Helper not found at $HELPER"

### Parse Flags
while [[ "${1:-}" == -* ]]; do
  case "$1" in
    -q|--quiet) QUIET=1; shift ;;
    -v|--verbose) VERBOSE=1; shift ;;
    --no-irq) NO_IRQ=1; shift ;;
    *) die "Unknown flag: $1" ;;
  esac
done


if [[ $# -eq 0 ]]; then
  die "Usage:
  $SCRIPT_NAME run <command...>
  $SCRIPT_NAME gaming [command...]
  $SCRIPT_NAME performance [command...]
  $SCRIPT_NAME toggle [command...]
  $SCRIPT_NAME status"
fi

COMMAND="$1"
shift

get_current_mode() {
  sudo "$HELPER" status | tr -d '\n'
}

toggle_mode() {
  case "$(get_current_mode)" in
    cache) echo "frequency" ;;
    frequency) echo "cache" ;;
    *) die "Unknown current mode" ;;
  esac
}

apply_profile_to_self() {
  local profile="$1"
  vlog "Applying profile: $profile"
  sudo "$HELPER" apply "$$" "$profile"
}

case "$COMMAND" in

run)
  [[ $# -eq 0 ]] && die "Usage: run <command...>"

  APP_KEY="$*"

  vlog "Querying profile for: $APP_KEY"

  PROFILE=$(sudo "$HELPER" query "$APP_KEY" 2>/dev/null || true)

  if [[ -z "$PROFILE" ]]; then
    vlog "No profile found; defaulting to 'gaming'"
    PROFILE="gaming"
  fi

  vlog "Applying profile: $PROFILE"

  sudo "$HELPER" apply "$$" "$PROFILE"

  exec "$@"
  ;;


  gaming)
    if [[ "$NO_IRQ" -eq 1 ]]; then
      sudo "$HELPER" cache --no-irq
    else
      sudo "$HELPER" cache
    fi

    log "Switched to cache"

    if [[ $# -gt 0 ]]; then
      apply_profile_to_self "gaming"
      exec "$@"
    fi
    ;;

  performance)
    if [[ "$NO_IRQ" -eq 1 ]]; then
      sudo "$HELPER" frequency --no-irq
    else
      sudo "$HELPER" frequency
    fi

    log "Switched to frequency"

    if [[ $# -gt 0 ]]; then
      apply_profile_to_self "frequency"
      exec "$@"
    fi
    ;;

  toggle)
    NEW_MODE=$(toggle_mode)

    if [[ "$NO_IRQ" -eq 1 ]]; then
      sudo "$HELPER" "$NEW_MODE" --no-irq
    else
      sudo "$HELPER" "$NEW_MODE"
    fi

    log "Switched to $NEW_MODE"

    if [[ $# -gt 0 ]]; then
      apply_profile_to_self "$NEW_MODE"
      exec "$@"
    fi
    ;;



  status)
    get_current_mode
    ;;

  *)
    die "Unknown command"
    ;;
esac

